openapi: 3.1.0
info:
  title: Coco FAQ API (Webhook + Supabase Sync + Auto Categories)
  description: |
    Manage FAQs at Coconut Beach.
    - Webhook: instant creation for voice/automation
    - Supabase: database persistence in `chatbot_faqs`
    - Auto-categorization: assigns FAQs to the right category
  version: 3.6.0
servers:
  - url: https://faq-webhook.vercel.app
    description: Voice-friendly webhook
tags:
  - name: Search
    description: Endpoints for finding FAQs
  - name: Management
    description: Endpoints for creating FAQs
  - name: Categories
    description: FAQ category listing
voice_input_handler: |
  async function handleVoiceFAQ(text) {
    try {
      const lowerText = text.trim().toLowerCase();
      
      // Handle "confirmed" to execute pending FAQ creation
      if (lowerText.includes('confirmed') || lowerText.includes('yes') || lowerText.includes('confirm')) {
        console.log('FAQ confirmation received via voice');
        
        // Check if we have pending FAQ data in session context
        if (globalThis.pendingFaq || (typeof session !== 'undefined' && session.pendingFaq)) {
          const pendingData = globalThis.pendingFaq || session.pendingFaq;
          const { question, answer } = pendingData;
          
          try {
            // Call the webhook to save FAQ
            await callPlugin('createFaqWebhook', {
              question: question,
              answer: answer
            });
            
            // Clear pending FAQ
            if (globalThis.pendingFaq) delete globalThis.pendingFaq;
            if (typeof session !== 'undefined' && session.pendingFaq) session.pendingFaq = null;
            
            return `‚úÖ Perfect! FAQ added: "${question}" üèùÔ∏è`;
          } catch (err) {
            console.error('Error saving FAQ:', err);
            return `‚ö†Ô∏è Got your confirmation, but something went wrong saving it. Can you repeat?`;
          }
        } else {
          return "I heard you, but I'm not sure which FAQ you were confirming‚Äîcould you resend?";
        }
      }
      
      // Handle cancellation
      if (lowerText.includes('cancel') || lowerText.includes('no')) {
        console.log('FAQ cancelled via voice');
        // Clear any pending FAQ
        if (globalThis.pendingFaq) delete globalThis.pendingFaq;
        if (typeof session !== 'undefined' && session.pendingFaq) session.pendingFaq = null;
        return "Okay, nothing saved üå¥";
      }
      
      // Standard FAQ triggers - these should work with CocoGPT's existing flow
      const triggerRegex = /^new faq\b|^add faq\b|^make faq\b|^create faq\b|^faq\b/i;
      
      if (triggerRegex.test(lowerText)) {
        console.log('FAQ creation triggered via voice:', text);
        
        // Try to parse question and answer from the voice input
        let cleaned = text.replace(triggerRegex, '').trim();
        const patterns = [
          /(?:question[:\s]+)(.+?)(?:\s+answer[:\s]+)(.+)/i,
          /(?:q[:\s]+)(.+?)(?:\s+a[:\s]+)(.+)/i,
          /(.+?)\s{3,}(.+)/i
        ];
        
        let question = '';
        let answer = '';
        
        for (const pattern of patterns) {
          const match = cleaned.match(pattern);
          if (match) {
            question = match[1].trim();
            answer = match[2].trim();
            break;
          }
        }
        
        if (question && answer) {
          // Store pending FAQ for confirmation
          const pendingFaq = { question, answer };
          if (typeof globalThis !== 'undefined') globalThis.pendingFaq = pendingFaq;
          if (typeof session !== 'undefined') session.pendingFaq = pendingFaq;
          
          return `Got it! New FAQ: "${question}" ‚Üí "${answer}". ‚úÖ Confirm?`;
        } else {
          return `üé§ I heard your FAQ request. Could you format it as: "new FAQ, question: [your question], answer: [your answer]"?`;
        }
      }
      
      // Don't intercept other voice commands
      return null;
    } catch (err) {
      console.error('Voice handler error:', err);
      return null;
    }
  }
commands:
  - name: faq_creation
    description: Create a new FAQ entry from a question and answer.
    triggers:
      - /^\/faq\b/i
      - /^slash faq\b/i
      - /^new faq\b/i
      - /^add faq\b/i
      - /^make faq\b/i
      - /^new question\b/i
      - /^voice faq confirmed\b/i
      - /^confirmed\b/i
    input_parsing:
      type: regex
      patterns:
        - pattern: (?:q:|question:|ask:)?\s*(.+?)\s*(?:a:|answer:|reply:)?\s*(.+)
          groups:
            question: 1
            answer: 2
        - pattern: (.+?)\s{3,}(.+)
          groups:
            question: 1
            answer: 2
    fallback_if_no_match:
      split_by_first_sentence: true
    ai_fallback_generate_question: true
    ai_fallback_generate_question_prompt: |
      You are CocoGPT, the Coconut Beach FAQ assistant.
      The user has provided an answer but no explicit question.
      Your task is to create a short, clear, guest-friendly FAQ question based on the answer.

      Rules:
      - Phrase as if the guest is asking it.
      - Use "What", "When", "Where", "How", or "Can" where appropriate.
      - Keep under 12 words if possible.
      - Make it natural for a tourist or guest to ask.
      - Avoid repeating the answer in the question.
    action:
      type: multi
      steps:
        - type: plugin
          plugin: faq_webhook_vercel_app__jit_plugin.createFaqWebhook
          params:
            question: "{{ question }}"
            answer: "{{ answer }}"
        - type: plugin
          plugin: insertFaq
          params:
            category: "{{ auto_category | default('general') }}"
            question: "{{ question }}"
            keywords: []
            answer: "{{ answer }}"
            is_active: true
    confirmation_template: "‚úÖ Got it. I've added your FAQ in '{{ auto_category | default('general') }}': '{{ question }}'."
paths:
  /faq-search:
    get:
      tags:
        - Search
      operationId: searchFaq
      summary: Search FAQs with fuzzy matching
      x-openai-isConsequential: false
      parameters:
        - in: query
          name: query
          required: true
          schema:
            type: string
        - in: query
          name: limit
          schema:
            type: integer
            default: 10
        - in: query
          name: category
          schema:
            type: string
      responses:
        "200":
          description: Matching FAQs
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/FaqSearchResult"
  /create:
    post:
      tags:
        - Management
      operationId: createFaqWebhook
      summary: Create a new FAQ entry instantly via webhook
      x-openai-isConsequential: false
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/FaqWebhookRequest"
      responses:
        "200":
          description: FAQ created successfully via webhook
  /rest/v1/chatbot_faqs:
    post:
      tags:
        - Management
      operationId: insertFaq
      summary: Insert FAQ into Supabase `chatbot_faqs`
      x-openai-isConsequential: false
      servers:
        - url: https://wcplwmvbhreevxvsdmog.supabase.co
      security:
        - supabaseServiceRole: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - category
                - question
                - answer
              properties:
                category:
                  type: string
                  default: general
                question:
                  type: string
                keywords:
                  type: array
                  items:
                    type: string
                answer:
                  type: string
                is_active:
                  type: boolean
                image_url:
                  type: string
                  nullable: true
      responses:
        "201":
          description: FAQ inserted successfully
components:
  securitySchemes:
    supabaseServiceRole:
      type: apiKey
      in: header
      name: Authorization
      x-placeholder: Bearer <SERVICE_ROLE_KEY>
      x-additional-headers:
        apikey: <SERVICE_ROLE_KEY>
  schemas:
    FaqSearchResult:
      type: object
      properties:
        id:
          type: integer
        category:
          type: string
        question:
          type: string
        answer:
          type: string
        keywords:
          type: array
          items:
            type: string
        is_active:
          type: boolean
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        image_url:
          type: string
          nullable: true
    FaqWebhookRequest:
      type: object
      required:
        - question
        - answer
      properties:
        question:
          type: string
        answer:
          type: string
